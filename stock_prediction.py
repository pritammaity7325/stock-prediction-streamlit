# -*- coding: utf-8 -*-
"""stock_prediction.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1TKGOKcWIxM7bsPqDFIifuJaHobNZjJQV
"""

pip install yfinance numpy pandas matplotlib scikit-learn tensorflow ta

import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import yfinance as yf

from sklearn.preprocessing import MinMaxScaler
from sklearn.metrics import mean_squared_error, mean_absolute_error

from tensorflow.keras.models import Sequential
from tensorflow.keras.layers import LSTM, Dense, Dropout
from tensorflow.keras.callbacks import EarlyStopping

import ta  # technical indicators

stock = "AAPL"   # change to TSLA, MSFT, TCS.NS, INFY.NS

data = yf.download(stock, period="5y", interval="1d")

# Force Close price to 1D numpy array
close_1d = data['Close'].values.flatten()

# Convert back to pandas Series
close_1d = pd.Series(close_1d, index=data.index)

data['SMA_20'] = ta.trend.sma_indicator(close=close_1d, window=20)
data['EMA_20'] = ta.trend.ema_indicator(close=close_1d, window=20)
data['RSI'] = ta.momentum.rsi(close=close_1d, window=14)

data.dropna(inplace=True)

features = ['Close', 'Volume', 'SMA_20', 'EMA_20', 'RSI']
dataset = data[features]

scaler = MinMaxScaler()
scaled_data = scaler.fit_transform(dataset)

train_size = int(len(scaled_data) * 0.8)
train_data = scaled_data[:train_size]
test_data = scaled_data[train_size-60:]

x_train, y_train = [], []

for i in range(60, len(train_data)):
    x_train.append(train_data[i-60:i])
    y_train.append(train_data[i, 0])  # Close price

x_train, y_train = np.array(x_train), np.array(y_train)

model = Sequential()

model.add(LSTM(64, return_sequences=True, input_shape=(60, x_train.shape[2])))
model.add(Dropout(0.2))

model.add(LSTM(64))
model.add(Dropout(0.2))

model.add(Dense(1))

model.compile(optimizer='adam', loss='mean_squared_error')

early_stop = EarlyStopping(monitor='loss', patience=3)

model.fit(
    x_train,
    y_train,
    epochs=20,
    batch_size=32,
    callbacks=[early_stop]
)

x_test = []
y_test = data['Close'].values[train_size:]

for i in range(60, len(test_data)):
    x_test.append(test_data[i-60:i])

x_test = np.array(x_test)

predictions = model.predict(x_test)

# Inverse scaling (only Close column)
close_scaler = MinMaxScaler()
close_scaler.fit(dataset[['Close']])

predictions = close_scaler.inverse_transform(predictions.reshape(-1,1))

train = data['Close'][:train_size]
test = data['Close'][train_size:]

plt.figure(figsize=(12,6))
plt.plot(train, label="Training Data")
plt.plot(test.index, test.values, label="Actual Test Data")
plt.plot(test.index, predictions, label="Predicted Test Data")

plt.title(f"{stock} Stock Price Prediction (Improved Model)")
plt.xlabel("Date")
plt.ylabel("Price")
plt.legend()
plt.show()

rmse = np.sqrt(mean_squared_error(test.values, predictions))
mae = mean_absolute_error(test.values, predictions)

print("RMSE:", rmse)
print("MAE:", mae)

last_30_days = data['Close'][-30:]

next_day_index = last_30_days.index[-1] + pd.Timedelta(days=1)

last_price = float(last_30_days.values[-1])
pred_price = float(next_day_price[0][0])

plt.figure(figsize=(12,6))

plt.plot(last_30_days.index, last_30_days.values, label="Last 30 Days")

plt.scatter(next_day_index, pred_price,
            color='red', s=120, label="Next Day Prediction")

plt.plot(
    [last_30_days.index[-1], next_day_index],
    [last_price, pred_price],
    linestyle='dashed'
)

plt.title(f"{stock} Next Day Prediction")
plt.xlabel("Date")
plt.ylabel("Price")
plt.legend()
plt.show()

